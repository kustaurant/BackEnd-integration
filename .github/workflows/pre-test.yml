name: 자동테스트

on:
  pull_request:
    branches: [ main, develop ]

permissions:
  checks: write
  pull-requests: write
  contents: read

jobs:
  small-test:
    name: 🧪 소형 테스트
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Run small tests
        run: ./gradlew --no-daemon clean smallTest

      - name: Publish Small Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: build/test-results/smallTest/TEST-*.xml
          check_name: 🧪 소형(단위) 테스트 결과
          check_run: false

  #      - name: Publish Test Report
  #        if: always()
  #        uses: dorny/test-reporter@v1
  #        with:
  #          name: 🧪 소형 테스트 리포트
  #          path: build/test-results/smallTest/*.xml
  #          reporter: java-junit

  middle-test:
    name: 🚀 중형 테스트
    runs-on: ubuntu-latest
    env:
      JWT_SECRET: thisIsA32ByteLengthSecretKeyForJWT!
      JWT_ACCESS_TOKEN_EXPIRATION : 900
      JWT_REFRESH_TOKEN_EXPIRATION : 604800
      NAVER_CLIENT_ID : kustaurant
      NAVER_CLIENT_SECRET : secreat
      APPLE_CLIENT_ID : kustaurant
      APPLE_PUBLIC_KEYS_URL : https://appleid.apple.com/auth/keys

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Docker info (for Testcontainers)
        run: docker info

      - name: Run middle tests
        run: ./gradlew --no-daemon middleTest

      - name: Publish Middle Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: build/test-results/middleTest/TEST-*.xml
          check_name: 🚀 중형(통합) 테스트 결과
          check_run: false

#      - name: Publish Test Report
#        if: always()
#        uses: dorny/test-reporter@v1
#        with:
#          name: 🚀 중형 테스트 리포트
#          path: build/test-results/middleTest/*.xml
#          reporter: java-junit