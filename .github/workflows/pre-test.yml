name: pre-test.yml

on:
  pull_request:
    branches: [ main, develop ]

permissions:
  checks: write
  pull-requests: write
  contents: read

jobs:
  small-test:
    name: ðŸ§ª Run Small(Unit) Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Gradle test (small only)
        run: ./gradlew smallTest
      - name: Publish Small Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: build/test-results/smallTest/TEST-*.xml
          check_name: ðŸ§ª Run Small(Unit) Tests
          check_run: false

  middle-test:
    name: ðŸš€ Run Middle(Integration) Tests
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:24.0.2
        options: >-
          --privileged
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Load ENV_FILE secret into .env file
        run: |
          printf "%s" "${{ secrets.ENV_FILE }}" > .env
      - name: Gradle test (middle only)
        run: ./gradlew middleTest
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_ACCESS_TOKEN_EXPIRATION: ${{ secrets.JWT_ACCESS_TOKEN_EXPIRATION }}
          JWT_REFRESH_TOKEN_EXPIRATION: ${{ secrets.JWT_REFRESH_TOKEN_EXPIRATION }}
      - name: Publish Middle Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: build/test-results/middleTest/TEST-*.xml
          check_name: ðŸš€ Run Middle(Integration) Tests
          check_run: false